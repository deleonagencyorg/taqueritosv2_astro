---
// src/views/Recipes/index.astro
import { getLocale } from '../../i18n/i18n';
import './styles.css';
import RecipeCard from '../../components/recipes/RecipeCard.astro';
import LazyImage from '../../components/common/LazyImage.astro';
import PixelGrid from '../../components/atoms/PixelGrid.astro';

interface Recipe {
  id: string;
  title: string;
  image?: string;
  preparation_time: number;
  type?: string;
}

const currentLang = getLocale();

// Get all recipe files with correct Vite glob typing
const recipeModules = import.meta.glob<{default: Recipe}>('../../locales/*/recipes/*.json');
const allRecipes: Recipe[] = [];

// Process each file
for (const path in recipeModules) {
  const lang = path.split('/')[3]; // Extract language from path
  if (lang === currentLang) {
    const module = await recipeModules[path]();
    allRecipes.push(module.default);
  }
}

// Shared translations
const noRecipesText = currentLang === 'es' 
  ? 'No hay recetas disponibles en este momento.' 
  : 'No recipes available at this time.';
const noFilterResultsText = currentLang === 'es'
  ? 'No se encontraron resultados para la selecci√≥n'
  : 'No results found for the selection';

// Filter labels
const filterLabels = currentLang === 'es'
  ? { 
      all: 'TODAS',
      breakfast: 'DESAYUNO', 
      brunch: 'BRUNCH',
      lunch: 'ALMUERZO'
    }
  : {
      all: 'ALL',
      breakfast: 'BREAKFAST',
      brunch: 'BRUNCH',
      lunch: 'LUNCH'
    };

// Normaliza el tipo (si no existe en JSON, lo deriva de category)
function normalizeType(r: Recipe): string {
  const raw = String((r as any).type || (r as any).category || '').toLowerCase().trim();
  if (['breakfast', 'desayuno'].includes(raw)) return 'breakfast';
  if (['brunch'].includes(raw)) return 'brunch';
  if (['lunch', 'almuerzo'].includes(raw)) return 'lunch';
  return 'other';
}
---
<div style=" background-image: url('https://snack.yummiespromociones.com/SnacksyummiesAssets/bgcontactzibas.webp'); background-size: cover; background-position: center; background-repeat: no-repeat;">
  
  <div class="container mx-auto px-4 mt-16">
    <div class="py-16">
      <div class="text-center mb-16 relative z-20 overflow-hidden" >
        <div class="absolute left-0 top-0 w-[100%] h-[100%] -z-10 pointer-events-none -ml-[250px]">
          <PixelGrid
             pixelSize={20}
             density={0.7}
             introDuration={800}
             loopInterval={1100}
             mutateAmount={50}
             background="none"
           />
        </div>
      <h2 class="text-3xl md:text-4xl italic font-bold mt-0 mb-4 text-white relative z-10">
        {currentLang==='es' ? 'Descubre nuestras' : 'Discover our'}
      </h2>
        <h1 class="text-6xl md:text-9xl italic font-bold mt-0 mb-4 text-white relative z-10 flex items-center justify-center">
          <span class="font-title pl-2 relative z-10">{currentLang==='es' ? 'Recetas' : 'Recipes'}</span>
        </h1>
    </div>
    </div>
    <!-- Filter Buttons -->
    <div id="recipeFilters" class="flex gap-4 mb-8 justify-center">
      <button class="filter-btn px-6 py-2 rounded-full bg-orange text-white font-bold hover:text-white hover:bg-orange-400 hover:opacity-100 active:text-white active:bg-orange-400 transition-colors border border-white" data-filter="all">{filterLabels.all}</button>
      <button class="filter-btn px-6 py-2 rounded-full bg-orange text-white font-bold hover:text-white hover:bg-orange-400 hover:opacity-100 active:text-white active:bg-orange-400 transition-colors border border-white" data-filter="breakfast">{filterLabels.breakfast}</button>
      <button class="filter-btn px-6 py-2 rounded-full bg-orange text-white font-bold hover:text-white hover:bg-orange-400 hover:opacity-100 active:text-white active:bg-orange-400 transition-colors border border-white" data-filter="brunch">{filterLabels.brunch}</button>
      <button class="filter-btn px-6 py-2 rounded-full bg-orange text-white font-bold hover:text-white hover:bg-orange-400 hover:opacity-100 active:text-white active:bg-orange-400 transition-colors border border-white" data-filter="lunch">{filterLabels.lunch}</button>
   </div>

    {allRecipes.length === 0 ? (
      <p class="text-center text-gray-500">{noRecipesText}</p>
    ) : (
      <div id="recipesGrid" class="md:w-[80%] w-full mx-auto grid grid-cols-2 md:grid-cols-3 md:gap-32 gap-6" transition:animate="slide">
        {allRecipes.map((recipe: Recipe) => (
          <div class="recipe-card" data-type={normalizeType(recipe)}>
            <RecipeCard
              image={recipe.image || '/images/recipes/placeholder.jpg'}
              title={recipe.title}
              time={`${recipe.preparation_time}MIN`}
              id={recipe.id}
              textColor="text-gray-800"
              iconColor="text-gray-800"
            />
          </div>
        ))}
      </div>
      <!-- No results message for filters -->
      <div id="noResults" class="hidden mt-6 items-center justify-center h-48 md:h-64">
        <span class="text-white text-lg md:text-xl font-semibold">{noFilterResultsText}</span>
      </div>
    )}
  </div>
</div>

<script>
  // This script runs only on the client side
  document.addEventListener('DOMContentLoaded', () => {
    // Fallback image handling
    const images = document.querySelectorAll('img');
    images.forEach((img) => {
      img.addEventListener('error', function() {
        this.src = '/images/recipes/placeholder.jpg';
      });
    });

    // Filters
    const filterButtons = Array.from(document.querySelectorAll('#recipeFilters .filter-btn')) as HTMLButtonElement[];
    const cards = Array.from(document.querySelectorAll('#recipesGrid .recipe-card')) as HTMLElement[];
    const noResultsEl = document.getElementById('noResults') as HTMLElement | null;

    function applyFilter(filter: string) {
      let anyVisible = false;
      cards.forEach((card) => {
        const type = (card.dataset.type || 'other').toLowerCase();
        const show = filter === 'all' || type === filter;
        card.style.display = show ? '' : 'none';
        if (show) anyVisible = true;
      });
      if (noResultsEl) {
        if (anyVisible) {
          noResultsEl.classList.add('hidden');
          noResultsEl.classList.remove('flex');
        } else {
          noResultsEl.classList.remove('hidden');
          noResultsEl.classList.add('flex');
        }
      }
    }

    function setActive(btn: HTMLButtonElement) {
      // Reset styles for all buttons
      filterButtons.forEach(b => {
        b.classList.remove('bg-orange', 'text-white', 'bg-orange', 'text-white', 'opacity-40', 'opacity-50');
      });
      // Highlight active
      btn.classList.add('bg-orange', 'text-white');
      // Dim the rest
      filterButtons.forEach(b => {
        if (b !== btn) b.classList.add('opacity-40');
      });
    }

    filterButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const filter = btn.getAttribute('data-filter') || 'all';
        setActive(btn as HTMLButtonElement);
        applyFilter(filter);
      });
    });

    // Initialize default state (ALL)
    const defaultBtn = filterButtons.find(b => b.getAttribute('data-filter') === 'all');
    if (defaultBtn) {
      setActive(defaultBtn);
      applyFilter('all');
    }
  });
</script>

<style>
  /* Active filter visual state (keeps tailwind classes consistent) */
  #recipeFilters .filter-btn.bg-brown {
    /* nothing else, class toggles handle colors */
  }
</style>
