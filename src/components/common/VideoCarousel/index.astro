---
import { Image } from 'astro:assets';

interface SlideItem {
  desktop: string;
  mobile: string;
  alt: string;
  title?: string;
  subtitle?: string;
  description?: string;
  link?: string;
}

interface Props {
  slides: SlideItem[];
  height?: string;
  mobileHeight?: string;
  overlayOpacity?: string;
  textColor?: string;
  showOverlay?: boolean;
}

const {
  slides = [],
  height = "100vh",
  mobileHeight = "300px",
  overlayOpacity = "50",
  textColor = "text-white",
  showOverlay = true
} = Astro.props;

// Identificar el primer slide para precargar
const firstSlide = slides[0] || {};
const isFirstSlideVideo = firstSlide.desktop?.toLowerCase().endsWith('.mp4') || 
                         firstSlide.desktop?.toLowerCase().endsWith('.webm');
---

<div class="video-carousel-container">
  <!-- Swiper container -->
  <div class="swiper-container video-carousel">
    <div class="swiper-wrapper">
      {slides.map((slide, index) => {
        const isVideo = slide.desktop?.toLowerCase().endsWith('.mp4') || 
                       slide.desktop?.toLowerCase().endsWith('.webm');
        const slideId = `slide-${index}`;
        
        return (
          <div class="swiper-slide" id={slideId}>
            <div class="slide-content" style={`height: ${height};`}>
              <!-- Fallback image that shows while video loads or if video fails -->
              <div class="fallback-image">
                <img 
                  src={isVideo ? slide.desktop.replace(/\.(mp4|webm)$/i, '.jpg') : slide.desktop} 
                  alt={slide.alt || "Slide background"} 
                  width="980" 
                  height="620"
                  loading={index === 0 ? "eager" : "lazy"}
                />
              </div>
{/*               
              {isVideo ? (
                <!-- Video background -->
                <div class="video-container">
                  <video 
                    autoplay 
                    muted 
                    loop 
                    playsinline
                    class="slide-video"
                    data-slide-id={slideId}
                    preload={index === 0 ? "auto" : "metadata"}
                  >
                    <source src={slide.desktop} type={slide.desktop.toLowerCase().endsWith('.webm') ? 'video/webm' : 'video/mp4'}>
                    <!-- If the browser doesn't support video, the fallback image will remain visible -->
                    Your browser does not support the video tag.
                  </video>
                </div>
              ) : ( */}
                <!-- Image background for non-video slides -->
                <div class="image-container relative w-full h-full flex items-center justify-center">
                  <!-- Imagen principal (desktop) -->
                  <img 
                    src={slide.desktop} 
                    alt={slide.alt || "Slide background"} 
                    class="slide-image desktop-image h-auto z-20 bg-transparent"
                    loading={index === 0 ? "eager" : "lazy"}
                  />

                  <!-- Imagen centrada (texto dragón) -->
                  <div class="w-full max-w-[98%] absolute text-center z-10 ">
                      <h1 
                        class="color-animate font-[700] uppercase leading-[100%] tracking-[0] text-[150px]  whitespace-nowrap z-10 select-none "
                        style="font-family: 'Avory I PE', sans-serif;"
                      >
                        DRAGON DE FUEGO
                      </h1>
                  </div>

                  <!-- Imagen móvil (opcional) -->
                  <img 
                    src={slide.mobile} 
                    alt={slide.alt || "Slide background"} 
                    class="slide-image mobile-image w-full h-auto z-20 bg-transparent"
                    loading={index === 0 ? "eager" : "lazy"}
                  />
                </div>

              {/* )} */}

              
              
              <!-- Overlay with text (conditional) -->
              {showOverlay && (slide.title || slide.subtitle) && (
                <div class={`overlay bg-black bg-opacity-${overlayOpacity}`}>
                  <div class="text-content">
                    {slide.title && <h1 class={`slide-title ${textColor}`}>{slide.title}</h1>}
                    {slide.subtitle && <p class={`slide-subtitle ${textColor}`}>{slide.subtitle}</p>}
                    {slide.link && (
                      <a href={slide.link} class="slide-link">
                        <span>Ver más</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <line x1="5" y1="12" x2="19" y2="12"></line>
                          <polyline points="12 5 19 12 12 19"></polyline>
                        </svg>
                      </a>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      })}
    </div>
    
    <!-- Navigation controls -->
    <div class="swiper-button-next"></div>
    <div class="swiper-button-prev"></div>
    <div class="swiper-pagination"></div>
  </div>
</div>

<style>
  /* Estilos para flechas y puntos de navegación blancos */
  :global(.swiper-button-next),
  :global(.swiper-button-prev) {
    color: white !important;
    filter: drop-shadow(0px 0px 3px rgba(0, 0, 0, 0.5));
  }
  
  :global(.swiper-pagination-bullet) {
    background: white !important;
    opacity: 0.7;
  }
  
  :global(.swiper-pagination-bullet-active) {
    opacity: 1;
    background: white !important;
  }
  
  .video-carousel-container {
    position: relative;
    width: 100%;
    overflow: hidden;
  }

    @keyframes colorCycle {
    0%   { color: #9a2d2e; }
    25%  { color: #ae5157; }
    50%  { color: #904d50; }
    75%  { color: #9c3235; }
    100% { color: #9a2d2e; }
  }

  .color-animate {
    animation: colorCycle 6s ease-in-out infinite;
  }
    

  .video-carousel-container::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.1);
    z-index: 1;
  }


/* ======= FONDO TIPO TAQUERITOS + HALOS ROJOS ======= */
/* Degradé oscuro del fondo del slide */
.slide-content{
  background:
    radial-gradient(120% 140% at 50% 0%, #1c0809 0%, #1b0708 55%, #290608 100%);
}

  /* Halos rojos laterales (óvalos) */

/* Elipse amplia + caída suave + sin borde visible */
.slide-content::before,
.slide-content::after{
  content:"";
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  /* más ancho que alto = menos “círculo” */
  width:60vw;              /* abre el halo */
  height:34vw;             /* más bajo */
  max-width:820px;
  max-height:460px;
  border-radius:50%;       /* base elíptica */

  /* 2 capas: núcleo rojo + halo suave MUY extendido */
  background:
    radial-gradient(ellipse 90% 70% at 50% 50%,
      rgba(255, 32, 54, .55) 0%,
      rgba(232, 20, 46, .42) 28%,
      rgba(200, 14, 40, .26) 52%,
      rgba(160, 10, 30, .14) 70%,
      rgba(120, 6, 20, .06) 82%,
      rgba(120, 6, 20, 0) 100%
    ),
    radial-gradient(ellipse 60% 45% at 50% 50%,
      rgba(255, 60, 80, .35) 0%,
      rgba(255, 60, 80, .00) 100%
    );

  /* difumina TODO el pseudoelemento (no solo el color) */
  filter: blur(50px);

  /* desactiva el “recorte” que hacía notar el borde */
  mix-blend-mode: normal;

  /* desvanecido extra de bordes para que nunca se lea círculo */
  -webkit-mask-image: radial-gradient(ellipse 40% 64% at 50% 50%,
    #000 65%, rgba(0,0,0,0) 100%);
          mask-image: radial-gradient(ellipse 40% 64% at 50% 50%,
    #000 65%, rgba(0,0,0,0) 100%);

  z-index:1;
  pointer-events:none;
}

/* Posición/rotación (ajústalo a gusto) */
.slide-content::before{
  left:-32vw;
  transform: translateY(-50%) rotate(88deg);
}
.slide-content::after{
  right:-32vw;
  transform: translateY(-50%) rotate(-88deg);
}



  

  /* Mantén tu comportamiento desktop/mobile */
  @media (min-width: 768px){
    .desktop-image{ display:block !important; }
    .mobile-image{ display:none !important; }
  }
  @media (max-width: 767px){
    .slide-content{ height: 78vh !important; } /* que respire en móvil */
    .desktop-image{ display:none !important; }
    .mobile-image{ display:block !important; }
  }

/* Flotado suave para la bolsa */
@keyframes floatHero{
  0%   { transform: translateY(0) rotate(-12deg); }
  50%  { transform: translateY(-18px) rotate(-12deg); }
  100% { transform: translateY(0) rotate(-12deg); }
}

  
  
  .slide-content {
    position: relative;
    width: 100%;
    overflow: hidden;
  }
  
  .fallback-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 920;
    height: 680;
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .fallback-image img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2;
  }
  
  .video-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2;
  }
  
  .slide-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .image-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2;
  }
  
  .slide-image {
    width: 920;
    height: 680;
    object-fit: cover;
    object-position: center;
  }
  
  .desktop-image {
    display: none;
    width: 920;
    height: 680;
  }
  
  .mobile-image {
    display: block;
    width: 920;
    height: 680;
  }
  
  .overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 3;
  }
  
  .text-content {
    text-align: center;
    padding: 0 1rem;
    max-width: 800px;
  }
  
  .slide-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
  }

  @keyframes floatUpDown {
    0% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(60px); /* mueve 20px hacia arriba */
    }
    100% {
      transform: translateY(0);
    }
  }

  .image-container .slide-image {
    animation: floatUpDown 2s ease-in-out infinite;
    transition: transform 1s ease-in-out;
  }

  @media (min-width: 768px) {
    .desktop-image {
      animation: floatUpDown 14s ease-in-out infinite;
    }
  }

  @media (max-width: 767px) {
    .mobile-image {
      animation: floatUpDown 10s ease-in-out infinite;
    }
  }
  
  .slide-subtitle {
    font-size: 1.5rem;
    font-weight: 400;
    margin-bottom: 2rem;
  }
  
  .slide-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: 9999px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .slide-link:hover {
    background-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
  }
  
  /* Responsive styles */
  @media (min-width: 768px) {
    .desktop-image {
      display: block;
    }
    
    .mobile-image {
      display: none;
    }
    
    .slide-title {
      font-size: 3.5rem;
    }
    
    .slide-subtitle {
      font-size: 2rem;
    }
  }
  
  @media (max-width: 767px) {
    .slide-content {
      height: 300px !important;
    }
  }
</style>

<script>
  import Swiper from 'swiper';
  import { Navigation, Pagination, Autoplay } from 'swiper/modules';
  import 'swiper/css';
  import 'swiper/css/navigation';
  import 'swiper/css/pagination';
  
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize Swiper
    const swiper = new Swiper('.video-carousel', {
      modules: [Navigation, Pagination, Autoplay],
      slidesPerView: 1,
      spaceBetween: 0,
      loop: true,
      autoplay: {
        delay: 5000,
        disableOnInteraction: false,
      },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
    });
    
    // Handle video playback
    const videos = document.querySelectorAll('.slide-video');
    const fallbackImages = document.querySelectorAll('.fallback-image');
    
    // Function to play video
    function playVideo(video) {
      if (!video) return;
      
      const playPromise = video.play();
      
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            // Video playback started successfully
            const slideId = video.getAttribute('data-slide-id');
            const fallbackImage = document.querySelector(`#${slideId} .fallback-image`);
            if (fallbackImage) {
              fallbackImage.style.opacity = '0';
            }
          })
          .catch(error => {
            // Auto-play was prevented
            console.warn('Video playback was prevented:', error);
          });
      }
    }
    
    // Function to pause all videos
    function pauseAllVideos() {
      videos.forEach(video => {
        video.pause();
      });
    }
    
    // Play video on active slide
    swiper.on('slideChange', () => {
      pauseAllVideos();
      
      const activeSlide = swiper.slides[swiper.activeIndex];
      const activeVideo = activeSlide?.querySelector('.slide-video');
      
      if (activeVideo) {
        setTimeout(() => playVideo(activeVideo), 300);
      }
    });
    
    // Play initial video
    const initialVideo = swiper.slides[swiper.activeIndex]?.querySelector('.slide-video');
    if (initialVideo) {
      playVideo(initialVideo);
    }
    
    // Handle video loading and fallback
    videos.forEach((video) => {
      const slideId = video.getAttribute('data-slide-id');
      const fallbackImage = document.querySelector(`#${slideId} .fallback-image`);
      
      // Hide fallback image once video can play
      video.addEventListener('canplay', () => {
        if (fallbackImage) {
          fallbackImage.style.opacity = '0';
        }
      });
      
      // Show fallback image if video errors
      video.addEventListener('error', () => {
        if (fallbackImage) {
          fallbackImage.style.opacity = '1';
        }
      });
    });
  });
</script>
